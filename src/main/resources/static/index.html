<!DOCTYPE html>
<html>
<head>
    <title>TODO List</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        input, button { padding: 10px; margin: 5px; }
        .input-container {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
        }
        #taskInput {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            padding: 12px 24px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        .task-container {
            margin-top: 20px;
        }
        .task-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .task-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .task-checkbox {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .task-content {
            flex: 1;
            font-size: 16px;
            transition: all 0.3s;
        }
        .task-completed .task-content{
            text-decoration: line-through;
            color: #888;
            opacity: 0.7;
        }
        .task-actions {
            display: flex;
            gap: 8px;
        }
        .delete-btn {
            background-color: #f44336;
            padding: 8px 16px;
            font-size: 14px;
            text-decoration: none !important; /* å¼ºåˆ¶ä¸åˆ’çº¿ */
            color: white !important;
            opacity: 1 !important;
        }
        /* å·²å®Œæˆä»»åŠ¡çš„åˆ é™¤æŒ‰é’®ç¨å¾®å˜æš— */
        .task-completed .delete-btn {
            background-color: #e57373;
            opacity: 0.9;
        }
        .delete-btn:hover {
            background-color: #d32f2f;
        }
        .stats {
            margin-top: 20px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            text-align: center;
            color: #666;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px 0;
            font-style: italic;
        }
    </style>
</head>
<body>
<h1>ğŸ“ TODO List</h1>

<div class="input-container">
    <input id="taskInput" placeholder="è¾“å…¥ä»»åŠ¡..." autocomplete="off" style="width: 70%;">
    <button onclick="addTask()">æ·»åŠ ä»»åŠ¡</button>
</div>

<div class="task-container" id="taskList"></div>

<div class="stats" id="stats"></div>

<script>
    const API_URL = '/api/tasks';

    // è¾…åŠ©å‡½æ•°ï¼šè½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
    function escapeHtml(str) {
        if (str == null) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è·å–å€¼
    function safeValue(value, defaultValue = '') {
        return value != null ? value : defaultValue;
    }

    // è·å–æ‰€æœ‰ä»»åŠ¡
    async function loadTasks() {
        try {
            const response = await fetch(API_URL);
            console.log('Response status:', response.status);  // è°ƒè¯•

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            console.log('Tasks data:', data);  // æŸ¥çœ‹æ•°æ®ç»“æ„
            let tasks = data;

            // å¦‚æœåç«¯è¿”å›çš„æ˜¯åŒ…è£…è¿‡çš„å“åº”
            if (data && typeof data === 'object') {
                if (Array.isArray(data)) {
                    tasks = data;  // ç›´æ¥æ˜¯æ•°ç»„
                } else if (data.data && Array.isArray(data.data)) {
                    tasks = data.data;  // {code: 200, data: [...]}
                } else if (data._embedded && data._embedded.tasks) {
                    tasks = data._embedded.tasks;  // Spring HATEOASæ ¼å¼
                }
            }

            if (!tasks || !Array.isArray(tasks)) {
                console.warn('Unexpected tasks format:', tasks);
                tasks = [];
            }

            console.log('Processed tasks:', tasks);
            // data.forEach((task, index) => {
            //     console.log(`Task ${index}:`, {
            //         id: task.id,
            //         title: task.title,
            //         completed: task.completed,
            //         type: typeof task.completed
            //     });
            // });

            renderTasks(tasks);
            updateStats(tasks);

        } catch (error) {
            console.error('åŠ è½½å¤±è´¥:', error);
            document.getElementById('taskList').innerHTML =
                '<div class="empty-state">âš ï¸ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨</div>';
            document.getElementById('stats').innerHTML = 'è¿æ¥å¤±è´¥';
        }
    }

    // æ·»åŠ ä»»åŠ¡
    async function addTask() {
        const input = document.getElementById('taskInput');
        const title = input.value.trim();

        if (!title) {
            alert('è¯·è¾“å…¥ä»»åŠ¡å†…å®¹');
            return;
        }

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // 'Accept': 'application/json'
                },
                body: JSON.stringify({ title: title, completed: false })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`æ·»åŠ å¤±è´¥: ${response.status} ${errorText}`);
            }

            input.value = '';
            input.focus();
            await loadTasks();
            showToast('âœ… ä»»åŠ¡æ·»åŠ æˆåŠŸ'); // åé¢åˆ æ‰è¿™ä¸ª
        } catch (error) {
            console.error('æ·»åŠ å¤±è´¥:', error);
            showToast('âŒ æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }

    // æ›´æ–°ä»»åŠ¡çŠ¶æ€
    async function toggleTask(id, currentState) {
        try {
            const response = await fetch(`${API_URL}/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json',
                    // 'Accept': 'application/json'
                },
                body: JSON.stringify({ completed: !currentState })
            });
            if (!response.ok) {
                throw new Error('æ›´æ–°å¤±è´¥');
            }
            await loadTasks();
            showToast('âœ… ä»»åŠ¡çŠ¶æ€å·²æ›´æ–°');
        } catch (error) {
            console.error('æ›´æ–°å¤±è´¥:', error);
            showToast('âŒ æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }

    // åˆ é™¤ä»»åŠ¡
    async function deleteTask(id, title) {
        if (!confirm(`ç¡®å®šåˆ é™¤ä»»åŠ¡ "${title}" å—ï¼Ÿ`)) return;

        try {
            const response = await fetch(`${API_URL}/${id}`, {
                method: 'DELETE'
            });
            if (!response.ok) {
                throw new Error('åˆ é™¤å¤±è´¥');
            }
            await loadTasks();
            showToast('ğŸ—‘ï¸ ä»»åŠ¡å·²åˆ é™¤');
        } catch (error) {
            console.error('åˆ é™¤å¤±è´¥:', error);
            showToast('âŒ åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }

    // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
    function renderTasks(tasks) {
        const container = document.getElementById('taskList');

        if (tasks.length === 0) {
            container.innerHTML = '<div class="empty-state">ğŸ“­ è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œæ·»åŠ ç¬¬ä¸€ä¸ªä»»åŠ¡å§ï¼</div>';
            return;
        }
        let html = '';
        // container.innerHTML = '';

        // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
        // tasks.sort((a, b) => {
        //     const timeA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
        //     const timeB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
        //     return timeB - timeA;
        // });

        tasks.forEach(task => {
            if (!task) return; // å®‰å…¨æ£€æŸ¥

            // const taskId = safeValue(task.id, 'unknown');
            // const taskTitle = safeValue(task.title, 'æ— æ ‡é¢˜');
            // const taskDesc = safeValue(task.description);
            // const completed = safeValue(task.completed, false);
            // const taskClass = completed ? 'task-item task-completed' : 'task-item';
            const taskId = task.id || 'unknown';
            const taskTitle = task.title || 'æ— æ ‡é¢˜';
            const taskDesc = task.description || '';
            const completed = task.completed || false;
            const taskClass = completed ? 'task-item task-completed' : 'task-item';

            // è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
            // const safeTitle = escapeHtml(taskTitle);
            // const safeDesc = escapeHtml(taskDesc);

            // å®‰å…¨çš„JavaScriptå­—ç¬¦ä¸²
            const safeJsTitle = taskTitle.replace(/'/g, "\\'").replace(/"/g, '\\"');

            html += `
                    <div class="${taskClass}" id="task-${taskId}">
                        <input type="checkbox"
                               class="task-checkbox"
                               ${completed ? 'checked' : ''}
                               onclick="toggleTask(${taskId}, ${completed})">

                        <div class="task-content ${completed ? 'task-completed' : ''}">
                            ${taskTitle}
                            ${taskDesc ? `<div style="font-size: 12px; color: #666; margin-top: 4px;">${taskDesc}</div>` : ''}
                        </div>

                        <div class="task-actions">
                            <button class="delete-btn"
                                    onclick="deleteTask('${taskId}', '${safeJsTitle}')">
                                  åˆ é™¤
                            </button>
                        </div>
                    </div>
                `;
        });

        container.innerHTML = html;
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats(tasks) {
        if (!tasks || !Array.isArray(tasks)) {
            document.getElementById('stats').innerHTML = 'æ•°æ®æ ¼å¼é”™è¯¯';
            return;
        }

        const total = tasks.length;
        const completed = tasks.filter(t => t.completed).length;
        const active = total - completed;

        document.getElementById('stats').innerHTML = `
                æ€»è®¡: ${total} ä¸ªä»»åŠ¡ |
                å·²å®Œæˆ: ${completed} ä¸ª |
                å¾…å®Œæˆ: ${active} ä¸ª
            `;
    }

    // æ˜¾ç¤ºToastæç¤º
    function showToast(message) {
        // ç§»é™¤ç°æœ‰çš„toast
        const existing = document.getElementById('toast');
        if (existing) existing.remove();

        // åˆ›å»ºæ–°çš„toast
        const toast = document.createElement('div');
        toast.id = 'toast';
        toast.textContent = message;
        toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #333;
                color: white;
                padding: 12px 20px;
                border-radius: 4px;
                z-index: 1000;
                animation: fadeInOut 3s ease-in-out;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        if (!document.getElementById('toast-style')) {
            const style = document.createElement('style');
            style.id = 'toast-style';
            style.textContent = `
                    @keyframes fadeInOut {
                        0% { opacity: 0; transform: translateY(-20px); }
                        10% { opacity: 1; transform: translateY(0); }
                        90% { opacity: 1; transform: translateY(0); }
                        100% { opacity: 0; transform: translateY(-20px); }
                    }
                `;
            document.head.appendChild(style);
        }

        document.body.appendChild(toast);

        // 3ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 3000);
    }

    // é¡µé¢åŠ è½½æ—¶è·å–ä»»åŠ¡
    document.addEventListener('DOMContentLoaded', () => {
        loadTasks();

        // æ”¯æŒå›è½¦é”®æ·»åŠ 
        document.getElementById('taskInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addTask();
        });

        // è¾“å…¥æ¡†è‡ªåŠ¨èšç„¦
        document.getElementById('taskInput').focus();
    });
</script>
</body>
</html>