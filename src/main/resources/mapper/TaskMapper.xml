<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.todo.mapper.TaskMapper">

    <!-- 结果映射 -->
    <resultMap id="TaskResultMap" type="Task">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="tag" column="tag"/>
        <result property="completed" column="completed"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="priority" column="priority"/>
        <result property="dueDate" column="due_date"/>
        <result property="deleted" column="deleted"/>
    </resultMap>

    <!-- 动态条件查询 -->
    <select id="findByConditions" resultMap="TaskResultMap" parameterType="map">
        SELECT * FROM todo_tasks
        WHERE deleted = 0
        <if test="title != null and title != ''">
            AND title LIKE CONCAT('%', #{title}, '%')
        </if>
        <if test="completed != null">
            AND completed = #{completed}
        </if>
        <if test="priority != null">
            AND priority = #{priority}
        </if>
        <if test="startDate != null">
            AND created_at >= #{startDate}
        </if>
        <if test="endDate != null">
            AND created_at &lt;= #{endDate}
        </if>
        ORDER BY
        <choose>
            <when test="sortBy == 'dueDate'">due_date</when>
            <when test="sortBy == 'priority'">priority DESC</when>
            <otherwise>created_at DESC</otherwise>
        </choose>
    </select>

    <!-- 查找即将到期的任务 -->
    <select id="findDueSoonTasks" resultMap="TaskResultMap">
        SELECT * FROM todo_tasks
        WHERE deleted = 0
          AND completed = 0
          AND due_date IS NOT NULL
          AND due_date BETWEEN NOW() AND DATE_ADD(NOW(), INTERVAL 3 DAY)
        ORDER BY due_date ASC
    </select>

    <!-- 统计查询 -->
    <select id="getStatistics" resultType="map">
        SELECT
            COUNT(*) as total,
            SUM(CASE WHEN completed = 1 THEN 1 ELSE 0 END) as completed,
            SUM(CASE WHEN completed = 0 THEN 1 ELSE 0 END) as active,
            SUM(CASE WHEN due_date IS NOT NULL
                AND due_date BETWEEN NOW() AND DATE_ADD(NOW(), INTERVAL 3 DAY)
                AND completed = 0
                         THEN 1 ELSE 0 END) as dueSoon
        FROM todo_tasks
        WHERE deleted = 0
    </select>

</mapper>